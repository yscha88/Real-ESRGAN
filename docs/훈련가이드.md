# :computer: Real-ESRGAN 훈련/미세조정 방법

- [Real-ESRGAN 훈련](#train-real-esrgan)
  - [개요](#overview)
  - [데이터셋 준비](#dataset-preparation)
  - [Real-ESRNet 훈련](#Train-Real-ESRNet)
  - [Real-ESRGAN 훈련](#Train-Real-ESRGAN)
- [자체 데이터셋으로 Real-ESRGAN 미세조정](#Finetune-Real-ESRGAN-on-your-own-dataset)
  - [실시간으로 열화 이미지 생성](#Generate-degraded-images-on-the-fly)
  - [쌍으로 이루어진 훈련 데이터 사용](#use-your-own-paired-data)

[English](훈련가이드) **|** [简体中文](Training_CN.md)

## Real-ESRGAN 훈련

### 개요

훈련은 두 단계로 나누어집니다. 이 두 단계는 손실 함수(loss function)를 제외하고 동일한 데이터 합성 과정과 훈련 파이프라인을 가집니다. 구체적으로,

1. 먼저 사전 훈련된 ESRGAN 모델로부터 L1 손실(L1 loss)을 사용하여 Real-ESRNet을 훈련합니다.
1. 그 다음 훈련된 Real-ESRNet 모델을 생성기(generator)의 초기화로 사용하고, L1 손실, 지각 손실(perceptual loss), GAN 손실의 조합으로 Real-ESRGAN을 훈련합니다.

### 데이터셋 준비

훈련에는 DF2K (DIV2K와 Flickr2K) + OST 데이터셋을 사용합니다. HR(고해상도) 이미지만 필요합니다. <br>
다음에서 다운로드할 수 있습니다:

1. DIV2K: http://data.vision.ee.ethz.ch/cvl/DIV2K/DIV2K_train_HR.zip
2. Flickr2K: https://cv.snu.ac.kr/research/EDSR/Flickr2K.tar
3. OST: https://openmmlab.oss-cn-hangzhou.aliyuncs.com/datasets/OST_dataset.zip

다음은 데이터 준비 단계입니다.

#### 1단계: [선택사항] 다중 스케일 이미지 생성

DF2K 데이터셋의 경우, 다중 스케일 전략을 사용합니다. 즉, HR 이미지를 다운샘플링하여 서로 다른 스케일의 여러 Ground-Truth 이미지를 얻습니다. <br>
다중 스케일 이미지를 생성하려면 [scripts/generate_multiscale_DF2K.py](scripts/generate_multiscale_DF2K.py) 스크립트를 사용할 수 있습니다. <br>
빠른 테스트만 원한다면 이 단계는 생략할 수 있습니다.

```bash
python scripts/generate_multiscale_DF2K.py --input datasets/DF2K/DF2K_HR --output datasets/DF2K/DF2K_multiscale
```

#### 2단계: [선택사항] 하위 이미지로 자르기

더 빠른 IO와 처리를 위해 DF2K 이미지를 하위 이미지로 자릅니다.<br>
IO가 충분하거나 디스크 공간이 제한적인 경우 이 단계는 선택사항입니다.

[scripts/extract_subimages.py](scripts/extract_subimages.py) 스크립트를 사용할 수 있습니다. 다음은 예시입니다:

```bash
 python scripts/extract_subimages.py --input datasets/DF2K/DF2K_multiscale --output datasets/DF2K/DF2K_multiscale_sub --crop_size 400 --step 200
```

#### 3단계: 메타 정보를 위한 txt 파일 준비

이미지 경로가 포함된 txt 파일을 준비해야 합니다. 다음은 `meta_info_DF2Kmultiscale+OST_sub.txt`의 몇 가지 예시입니다 (사용자마다 다른 하위 이미지 분할을 가질 수 있으므로, 이 파일은 귀하의 목적에 적합하지 않으며 자체 txt 파일을 준비해야 합니다):

```txt
DF2K_HR_sub/000001_s001.png
DF2K_HR_sub/000001_s002.png
DF2K_HR_sub/000001_s003.png
...
```

txt 파일을 생성하려면 [scripts/generate_meta_info.py](scripts/generate_meta_info.py) 스크립트를 사용할 수 있습니다. <br>
여러 폴더를 하나의 meta_info txt 파일로 병합할 수 있습니다. 다음은 예시입니다:

```bash
 python scripts/generate_meta_info.py --input datasets/DF2K/DF2K_HR datasets/DF2K/DF2K_multiscale --root datasets/DF2K datasets/DF2K --meta_info datasets/DF2K/meta_info/meta_info_DF2Kmultiscale.txt
```

### Real-ESRNet 훈련

1. 사전 훈련된 모델 [ESRGAN](https://github.com/xinntao/Real-ESRGAN/releases/download/v0.1.1/ESRGAN_SRx4_DF2KOST_official-ff704c30.pth)을 `experiments/pretrained_models`에 다운로드합니다.
    ```bash
    wget https://github.com/xinntao/Real-ESRGAN/releases/download/v0.1.1/ESRGAN_SRx4_DF2KOST_official-ff704c30.pth -P experiments/pretrained_models
    ```
1. 옵션 파일 `options/train_realesrnet_x4plus.yml`의 내용을 적절히 수정합니다:
    ```yml
    train:
        name: DF2K+OST
        type: RealESRGANDataset
        dataroot_gt: datasets/DF2K  # modify to the root path of your folder
        meta_info: realesrgan/meta_info/meta_info_DF2Kmultiscale+OST_sub.txt  # modify to your own generate meta info txt
        io_backend:
            type: disk
    ```
1. 훈련 중에 검증을 수행하려면, 해당 라인의 주석을 제거하고 적절히 수정합니다:
    ```yml
      # Uncomment these for validation
      # val:
      #   name: validation
      #   type: PairedImageDataset
      #   dataroot_gt: path_to_gt
      #   dataroot_lq: path_to_lq
      #   io_backend:
      #     type: disk

    ...

      # Uncomment these for validation
      # validation settings
      # val:
      #   val_freq: !!float 5e3
      #   save_img: True

      #   metrics:
      #     psnr: # metric name, can be arbitrary
      #       type: calculate_psnr
      #       crop_border: 4
      #       test_y_channel: false
    ```
1. 정식 훈련 전에, 모든 것이 정상인지 확인하기 위해 `--debug` 모드로 실행할 수 있습니다. 훈련에는 4개의 GPU를 사용합니다:
    ```bash
    CUDA_VISIBLE_DEVICES=0,1,2,3 \
    python -m torch.distributed.launch --nproc_per_node=4 --master_port=4321 realesrgan/train.py -opt options/train_realesrnet_x4plus.yml --launcher pytorch --debug
    ```

    *debug* 모드에서 **단일 GPU**로 훈련:
    ```bash
    python realesrgan/train.py -opt options/train_realesrnet_x4plus.yml --debug
    ```
1. 정식 훈련. 훈련에는 4개의 GPU를 사용합니다. 필요한 경우 자동으로 훈련을 재개하기 위해 `--auto_resume` 인수를 사용합니다.
    ```bash
    CUDA_VISIBLE_DEVICES=0,1,2,3 \
    python -m torch.distributed.launch --nproc_per_node=4 --master_port=4321 realesrgan/train.py -opt options/train_realesrnet_x4plus.yml --launcher pytorch --auto_resume
    ```

    **단일 GPU**로 훈련:
    ```bash
    python realesrgan/train.py -opt options/train_realesrnet_x4plus.yml --auto_resume
    ```

### Real-ESRGAN 훈련

1. Real-ESRNet 훈련 후, `experiments/train_RealESRNetx4plus_1000k_B12G4_fromESRGAN/model/net_g_1000000.pth` 파일을 얻게 됩니다. 다른 파일에 대한 사전 훈련 경로를 지정해야 하는 경우, 옵션 파일 `train_realesrgan_x4plus.yml`에서 `pretrain_network_g` 값을 수정합니다.
1. 옵션 파일 `train_realesrgan_x4plus.yml`을 적절히 수정합니다. 대부분의 수정 사항은 위에 나열된 것과 유사합니다.
1. 정식 훈련 전에, 모든 것이 정상인지 확인하기 위해 `--debug` 모드로 실행할 수 있습니다. 훈련에는 4개의 GPU를 사용합니다:
    ```bash
    CUDA_VISIBLE_DEVICES=0,1,2,3 \
    python -m torch.distributed.launch --nproc_per_node=4 --master_port=4321 realesrgan/train.py -opt options/train_realesrgan_x4plus.yml --launcher pytorch --debug
    ```

    *debug* 모드에서 **단일 GPU**로 훈련:
    ```bash
    python realesrgan/train.py -opt options/train_realesrgan_x4plus.yml --debug
    ```
1. 정식 훈련. 훈련에는 4개의 GPU를 사용합니다. 필요한 경우 자동으로 훈련을 재개하기 위해 `--auto_resume` 인수를 사용합니다.
    ```bash
    CUDA_VISIBLE_DEVICES=0,1,2,3 \
    python -m torch.distributed.launch --nproc_per_node=4 --master_port=4321 realesrgan/train.py -opt options/train_realesrgan_x4plus.yml --launcher pytorch --auto_resume
    ```

    **단일 GPU**로 훈련:
    ```bash
    python realesrgan/train.py -opt options/train_realesrgan_x4plus.yml --auto_resume
    ```

## 자체 데이터셋으로 Real-ESRGAN 미세조정

자체 데이터셋으로 Real-ESRGAN을 미세조정할 수 있습니다. 일반적으로 미세조정 과정은 두 가지 경우로 나눌 수 있습니다:

1. [실시간으로 열화 이미지 생성](#Generate-degraded-images-on-the-fly)
1. [자체 **쌍** 데이터 사용](#Use-paired-training-data)

### 실시간으로 열화 이미지 생성

고해상도 이미지만 필요합니다. 저품질 이미지는 훈련 중에 Real-ESRGAN에서 설명된 열화 과정으로 생성됩니다.

**1. 데이터셋 준비**

자세한 내용은 [이 섹션](#dataset-preparation)을 참조하세요.

**2. 사전 훈련된 모델 다운로드**

사전 훈련된 모델을 `experiments/pretrained_models`에 다운로드합니다.

- *RealESRGAN_x4plus.pth*:
    ```bash
    wget https://github.com/xinntao/Real-ESRGAN/releases/download/v0.1.0/RealESRGAN_x4plus.pth -P experiments/pretrained_models
    ```

- *RealESRGAN_x4plus_netD.pth*:
    ```bash
    wget https://github.com/xinntao/Real-ESRGAN/releases/download/v0.2.2.3/RealESRGAN_x4plus_netD.pth -P experiments/pretrained_models
    ```

**3. 미세조정**

특히 `datasets` 부분을 중심으로 [options/finetune_realesrgan_x4plus.yml](options/finetune_realesrgan_x4plus.yml)을 적절히 수정합니다:

```yml
train:
    name: DF2K+OST
    type: RealESRGANDataset
    dataroot_gt: datasets/DF2K  # modify to the root path of your folder
    meta_info: realesrgan/meta_info/meta_info_DF2Kmultiscale+OST_sub.txt  # modify to your own generate meta info txt
    io_backend:
        type: disk
```

훈련에는 4개의 GPU를 사용합니다. 필요한 경우 자동으로 훈련을 재개하기 위해 `--auto_resume` 인수를 사용합니다.

```bash
CUDA_VISIBLE_DEVICES=0,1,2,3 \
python -m torch.distributed.launch --nproc_per_node=4 --master_port=4321 realesrgan/train.py -opt options/finetune_realesrgan_x4plus.yml --launcher pytorch --auto_resume
```

**단일 GPU**로 미세조정:
```bash
python realesrgan/train.py -opt options/finetune_realesrgan_x4plus.yml --auto_resume
```

### 자체 쌍 데이터 사용

자체 쌍 데이터로도 RealESRGAN을 미세조정할 수 있습니다. 이는 ESRGAN 미세조정과 더 유사합니다.

**1. 데이터셋 준비**

이미 두 폴더가 있다고 가정합니다:

- **gt 폴더** (Ground-truth, 고해상도 이미지): *datasets/DF2K/DIV2K_train_HR_sub*
- **lq 폴더** (저품질, 저해상도 이미지): *datasets/DF2K/DIV2K_train_LR_bicubic_X4_sub*

그런 다음, 스크립트 [scripts/generate_meta_info_pairdata.py](scripts/generate_meta_info_pairdata.py)를 사용하여 meta_info txt 파일을 준비할 수 있습니다:

```bash
python scripts/generate_meta_info_pairdata.py --input datasets/DF2K/DIV2K_train_HR_sub datasets/DF2K/DIV2K_train_LR_bicubic_X4_sub --meta_info datasets/DF2K/meta_info/meta_info_DIV2K_sub_pair.txt
```

**2. 사전 훈련된 모델 다운로드**

사전 훈련된 모델을 `experiments/pretrained_models`에 다운로드합니다.

- *RealESRGAN_x4plus.pth*
    ```bash
    wget https://github.com/xinntao/Real-ESRGAN/releases/download/v0.1.0/RealESRGAN_x4plus.pth -P experiments/pretrained_models
    ```

- *RealESRGAN_x4plus_netD.pth*
    ```bash
    wget https://github.com/xinntao/Real-ESRGAN/releases/download/v0.2.2.3/RealESRGAN_x4plus_netD.pth -P experiments/pretrained_models
    ```

**3. 미세조정**

특히 `datasets` 부분을 중심으로 [options/finetune_realesrgan_x4plus_pairdata.yml](options/finetune_realesrgan_x4plus_pairdata.yml)을 적절히 수정합니다:

```yml
train:
    name: DIV2K
    type: RealESRGANPairedDataset
    dataroot_gt: datasets/DF2K  # modify to the root path of your folder
    dataroot_lq: datasets/DF2K  # modify to the root path of your folder
    meta_info: datasets/DF2K/meta_info/meta_info_DIV2K_sub_pair.txt  # modify to your own generate meta info txt
    io_backend:
        type: disk
```

훈련에는 4개의 GPU를 사용합니다. 필요한 경우 자동으로 훈련을 재개하기 위해 `--auto_resume` 인수를 사용합니다.

```bash
CUDA_VISIBLE_DEVICES=0,1,2,3 \
python -m torch.distributed.launch --nproc_per_node=4 --master_port=4321 realesrgan/train.py -opt options/finetune_realesrgan_x4plus_pairdata.yml --launcher pytorch --auto_resume
```

**단일 GPU**로 미세조정:
```bash
python realesrgan/train.py -opt options/finetune_realesrgan_x4plus_pairdata.yml --auto_resume
```